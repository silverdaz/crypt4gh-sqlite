
CC      = @CC@
CPPFLAGS= -Isrc @CPPFLAGS@ -fPIC
CFLAGS  = -Wno-unused-result @CFLAGS@ @CPPFLAGS@ @DEFS@ @DEBUG@ -DSQLITE_OMIT_LOAD_EXTENSION
LIBS    = @LIBS@
LDFLAGS = @LDFLAGS@
#INSTALL = @INSTALL@
INSTALL = /usr/bin/install -c

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir = @bindir@
libdir = @libdir@

TARGET=crypt4gh-sqlite.fs

KEYS_OBJS = src/keys/base64.o src/keys/bcrypt_pbkdf.o src/keys/blowfish.o \
	    src/keys/explicit_bzero.o src/keys/freezero.o src/keys/kdf.o \
	    src/keys/key.o src/keys/readpassphrase.o src/keys/sha2.o \
	    src/keys/timingsafe_bcmp.o

OBJS =  src/fs.o src/sqlite-3.45.2/sqlite3.o src/main.o src/crypt4gh.o $(KEYS_OBJS)

.PHONY: $(TARGET)

all: $(TARGET)

$(libdir) $(bindir):
	mkdir -p $@

$(TARGET): $(OBJS)
	@echo "Creating target $@"
	@$(CC) -o $@ $(OBJS) $(LDFLAGS) $(LIBS)

.c.o:
	@echo "Compiling $<"
	$(CC) $(CPPFLAGS) $(CFLAGS) -c -o $@ $<

clean:
	-rm -f $(OBJS) $(TARGET)
	-@rm -f *~ 

install: $(TARGET)
	$(INSTALL) -m 0755 $(TARGET) $(bindir)/$(TARGET)

distclean: clean
	-rm -f Makefile src/config.h* config.status configure config.log
	-rm -rf autom4te.cache aclocal.m4 src/.depend.old


###################################
## Dependencies
###################################
depend: depend-rebuild
	rm -f src/.depend.bak

depend-rebuild:
	mv src/.depend src/.depend.old
	rm -f src/config.h src/.depend
	touch src/config.h src/.depend
	makedepend -w1000 -I./src -DHAVE_CONFIG_H -Ysrc -f src/.depend src/*.c src/keys/*.c src/sqlite-3.45.2/*.c 2>/dev/null
	(echo '# Automatically generated by makedepend.'; \
	 echo '# Run "make depend" to rebuild.'; sort src/.depend ) >src/.depend.tmp
	mv src/.depend.tmp src/.depend
	rm -f src/.depend.bak
	mv src/.depend.old src/.depend.bak

depend-check: depend-rebuild
	cmp src/.depend src/.depend.bak || (echo src/.depend stale && exit 1)

# @DEPEND@
